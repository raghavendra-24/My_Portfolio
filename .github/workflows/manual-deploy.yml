name: Manual Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to (production only)'
        required: true
        default: 'production'
        type: choice
        options:
          - production
      skip_tests:
        description: 'Skip running tests'
        required: false
        default: false
        type: boolean
      reason:
        description: 'Reason for manual deployment'
        required: true
        type: string

concurrency:
  group: deploy-${{ inputs.environment }}
  cancel-in-progress: false

permissions:
  contents: read
  deployments: write
  id-token: write

env:
  AWS_REGION: us-east-1

jobs:
  validate:
    name: Validate Deployment
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Log deployment reason
        env:
          DEPLOY_ENV: ${{ inputs.environment }}
          DEPLOY_REASON: ${{ inputs.reason }}
          DEPLOY_SKIP_TESTS: ${{ inputs.skip_tests }}
        run: |
          echo "üöÄ Manual deployment initiated"
          echo "Environment: $DEPLOY_ENV"
          echo "Initiated by: ${{ github.actor }}"
          echo "Reason: $DEPLOY_REASON"
          echo "Skip tests: $DEPLOY_SKIP_TESTS"

      - name: Validate environment
        env:
          DEPLOY_ENV: ${{ inputs.environment }}
          GIT_REF: ${{ github.ref }}
        run: |
          if [[ "$DEPLOY_ENV" == "production" && "$GIT_REF" != "refs/heads/main" ]]; then
            echo "‚ùå Production deployments are only allowed from the main branch"
            exit 1
          fi

      - name: Validate required secrets/variables
        shell: bash
        env:
          AWS_DEPLOY_ROLE_ARN: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          CONTACT_EMAIL: ${{ vars.CONTACT_EMAIL }}
          NEXT_PUBLIC_APP_URL: ${{ vars.NEXT_PUBLIC_APP_URL }}
        run: |
          set -euo pipefail

          if [[ -z "${AWS_DEPLOY_ROLE_ARN}" ]]; then
            echo "Missing required secret: AWS_DEPLOY_ROLE_ARN" >&2
            exit 1
          fi
          if [[ ! "${AWS_DEPLOY_ROLE_ARN}" =~ ^arn:aws:iam::[0-9]{12}:role/.+ ]]; then
            echo "AWS_DEPLOY_ROLE_ARN must be a full IAM Role ARN (got a non-ARN value)." >&2
            echo "Expected format: arn:aws:iam::123456789012:role/prod-portfolio-deploy" >&2
            exit 1
          fi

          if [[ -z "${CONTACT_EMAIL}" || ! "${CONTACT_EMAIL}" =~ ^[^@[:space:]]+@[^@[:space:]]+\.[^@[:space:]]+$ ]]; then
            echo "CONTACT_EMAIL must be set to a valid email address for this environment." >&2
            exit 1
          fi
          if [[ -z "${NEXT_PUBLIC_APP_URL}" || ! "${NEXT_PUBLIC_APP_URL}" =~ ^https?:// ]]; then
            echo "NEXT_PUBLIC_APP_URL must be set and start with http:// or https:// for this environment." >&2
            exit 1
          fi

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: validate
    if: inputs.skip_tests != true
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          install: "true"

      - name: Run tests
        run: |
          pnpm lint
          pnpm type-check
          pnpm test

  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    needs: [validate, test]
    if: always() && needs.validate.result == 'success' && (needs.test.result == 'success' || inputs.skip_tests == true)
    environment:
      name: ${{ inputs.environment }}
      url: ${{ steps.deployment-url.outputs.url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          install: "true"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          role-session-name: github-actions-manual-deploy
          aws-region: ${{ env.AWS_REGION }}
          mask-aws-account-id: true

      - name: Preflight - verify CloudFormation exports access
        shell: bash
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
        run: |
          set -euo pipefail

          if ! OUTPUT="$(aws cloudformation list-exports --max-items 1 --region "${AWS_REGION}" 2>&1)"; then
            echo "ERROR: Unable to call CloudFormation ListExports (required by deploy-static-site.mjs)." >&2
            echo "${OUTPUT}" >&2
            echo "" >&2
            echo "Fix (IAM): allow cloudformation:ListExports on Resource \"*\" for the deploy role." >&2
            exit 1
          fi

      - name: Preflight - verify static deploy permissions (S3 + CSP KVS)
        shell: bash
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
        run: |
          set -euo pipefail

          STACK_ENV="prod"
          bucket="$(aws cloudformation list-exports --region "${AWS_REGION}" --query "Exports[?Name=='${STACK_ENV}-website-bucket-name'].Value | [0]" --output text)"
          distribution_id="$(aws cloudformation list-exports --region "${AWS_REGION}" --query "Exports[?Name=='${STACK_ENV}-distribution-id'].Value | [0]" --output text)"
          kvs_arn="$(aws cloudformation list-exports --region "${AWS_REGION}" --query "Exports[?Name=='${STACK_ENV}-csp-hashes-kvs-arn'].Value | [0]" --output text)"

          if [[ -z "${bucket}" || "${bucket}" == "None" ]]; then
            echo "ERROR: Unable to resolve export: ${STACK_ENV}-website-bucket-name" >&2
            exit 1
          fi
          if [[ -z "${distribution_id}" || "${distribution_id}" == "None" ]]; then
            echo "ERROR: Unable to resolve export: ${STACK_ENV}-distribution-id" >&2
            exit 1
          fi
          if [[ -z "${kvs_arn}" || "${kvs_arn}" == "None" ]]; then
            echo "ERROR: Unable to resolve export: ${STACK_ENV}-csp-hashes-kvs-arn" >&2
            exit 1
          fi

          if ! aws s3 ls "s3://${bucket}" >/dev/null 2>&1; then
            echo "ERROR: Unable to list S3 bucket s3://${bucket} (required by deploy-static-site.mjs)." >&2
            echo "Fix (IAM): allow s3:ListBucket on arn:aws:s3:::${bucket} (and object write permissions)." >&2
            exit 1
          fi

          if ! aws cloudfront-keyvaluestore describe-key-value-store --kvs-arn "${kvs_arn}" >/dev/null 2>&1; then
            echo "ERROR: Unable to describe CloudFront KeyValueStore ${kvs_arn} (required by deploy-static-site.mjs)." >&2
            echo "Fix (IAM): allow cloudfront-keyvaluestore:DescribeKeyValueStore/ListKeys/UpdateKeys on ${kvs_arn}." >&2
            exit 1
          fi

          if ! aws cloudfront list-invalidations --distribution-id "${distribution_id}" --max-items 1 >/dev/null 2>&1; then
            echo "ERROR: Unable to list CloudFront invalidations for distribution ${distribution_id} (required by deploy-static-site.mjs)." >&2
            echo "Fix (IAM): allow cloudfront:ListInvalidations/GetInvalidation/CreateInvalidation on the distribution ARN." >&2
            exit 1
          fi

      - name: Build application
        run: pnpm build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_ENVIRONMENT: ${{ inputs.environment }}
          NEXT_PUBLIC_BASE_URL: ${{ vars.NEXT_PUBLIC_BASE_URL }}
          NEXT_PUBLIC_API_URL: ${{ vars.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_APP_URL: ${{ vars.NEXT_PUBLIC_APP_URL }}
          CONTACT_EMAIL: ${{ vars.CONTACT_EMAIL }}
          AWS_REGION: ${{ env.AWS_REGION }}

      - name: Deploy to environment
        env:
          DEPLOY_ENV: ${{ inputs.environment }}
        run: |
          set -euo pipefail

          STACK_ENV="prod"

          echo "Deploying static export using environment prefix: ${STACK_ENV}"
          node scripts/deploy-static-site.mjs --env "${STACK_ENV}"

      - name: Set deployment URL
        id: deployment-url
        env:
          APP_URL: ${{ vars.NEXT_PUBLIC_APP_URL }}
        run: |
          set -euo pipefail
          if [[ -z "${APP_URL}" ]]; then
            echo "Missing required variable: NEXT_PUBLIC_APP_URL" >&2
            exit 1
          fi
          echo "url=${APP_URL}" >> "$GITHUB_OUTPUT"

      - name: Create deployment record
        uses: actions/github-script@v8
        env:
          DEPLOY_ENV: ${{ inputs.environment }}
          DEPLOY_REASON: ${{ inputs.reason }}
        with:
          script: |
            await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: process.env.DEPLOY_ENV,
              description: `Manual deployment: ${process.env.DEPLOY_REASON}`,
              auto_merge: false,
              required_contexts: []
            });

      - name: Send deployment notification
        if: always()
        env:
          DEPLOY_ENV: ${{ inputs.environment }}
          JOB_STATUS: ${{ job.status }}
        run: |
          if [[ "$JOB_STATUS" == "success" ]]; then
            echo "‚úÖ Deployment to $DEPLOY_ENV completed successfully"
          else
            echo "‚ùå Deployment to $DEPLOY_ENV failed"
          fi
