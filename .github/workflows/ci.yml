name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  pull-requests: write

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  ci:
    name: CI Pipeline
    uses: ./.github/workflows/_reusable-ci.yml
    with:
      run-e2e: true
      run-unit-tests: true

  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.0
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: pnpm
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Run markdownlint
        run: pnpm lint:md

  actionlint:
    name: Actionlint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Run actionlint
        uses: reviewdog/action-actionlint@83e4ed25b168066ad8f62f5afbb29ebd8641d982 # v1.69.1
        with:
          reporter: github-check
          level: error

  all-checks-passed:
    name: All CI Checks Passed
    runs-on: ubuntu-latest
    needs: [ci, markdown-lint, actionlint]
    if: always()
    steps:
      - name: Check all job statuses
        run: |
          good() { case "$1" in success|skipped) return 0;; *) return 1;; esac; }
          if ! good "${{ needs.ci.result }}"; then echo "CI failed"; exit 1; fi
          if ! good "${{ needs.markdown-lint.result }}"; then echo "Markdown linting failed"; exit 1; fi
          if ! good "${{ needs.actionlint.result }}"; then echo "Actionlint failed"; exit 1; fi
          echo "All CI checks passed successfully!"
