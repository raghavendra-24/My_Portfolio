name: Deploy Portfolio

on:
  push:
    branches:
      - main
    paths-ignore:
      - "**.md"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Validate build + AWS auth/outputs only (no S3 upload / KVS sync / CloudFront invalidation)"
        required: false
        type: boolean
        default: false
      skip_smoke_check:
        description: "Skip post-deploy smoke check (workflow_dispatch only)"
        required: false
        type: boolean
        default: false

concurrency:
  group: deploy
  cancel-in-progress: false

env:
  AWS_REGION: us-east-1

jobs:
  preflight:
    name: Preflight (Production Config)
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
    steps:
      - name: Validate required secrets/variables
        shell: bash
        env:
          AWS_DEPLOY_ROLE_ARN: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          CONTACT_EMAIL: ${{ vars.CONTACT_EMAIL }}
          NEXT_PUBLIC_APP_URL: ${{ vars.NEXT_PUBLIC_APP_URL }}
        run: |
          set -euo pipefail

          if [[ -z "${AWS_DEPLOY_ROLE_ARN}" ]]; then
            echo "Missing required secret: AWS_DEPLOY_ROLE_ARN" >&2
            exit 1
          fi
          if [[ ! "${AWS_DEPLOY_ROLE_ARN}" =~ ^arn:aws:iam::[0-9]{12}:role/.+ ]]; then
            echo "AWS_DEPLOY_ROLE_ARN must be a full IAM Role ARN (got a non-ARN value)." >&2
            echo "Expected format: arn:aws:iam::123456789012:role/prod-portfolio-deploy" >&2
            exit 1
          fi

          if [[ -z "${CONTACT_EMAIL}" ]]; then
            echo "Missing required variable: CONTACT_EMAIL (GitHub Environment: production)" >&2
            exit 1
          fi
          if [[ ! "${CONTACT_EMAIL}" =~ ^[^@[:space:]]+@[^@[:space:]]+\.[^@[:space:]]+$ ]]; then
            echo "CONTACT_EMAIL must be a valid email address (GitHub Environment: production)." >&2
            exit 1
          fi

          if [[ -z "${NEXT_PUBLIC_APP_URL}" ]]; then
            echo "Missing required variable: NEXT_PUBLIC_APP_URL (GitHub Environment: production)" >&2
            exit 1
          fi
          if [[ ! "${NEXT_PUBLIC_APP_URL}" =~ ^https?:// ]]; then
            echo "NEXT_PUBLIC_APP_URL must start with http:// or https:// (GitHub Environment: production)." >&2
            exit 1
          fi

  ci:
    name: CI Pipeline
    uses: ./.github/workflows/_reusable-ci.yml
    needs: preflight
    with:
      run-e2e: true
      run-unit-tests: true

  deploy:
    name: Deploy to Production
    needs: ci
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          install: 'true'

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          role-session-name: github-actions-deploy
          aws-region: ${{ env.AWS_REGION }}
          mask-aws-account-id: true

      - name: Build Next.js App (Static Export)
        env:
          NEXT_PUBLIC_BASE_URL: ${{ vars.NEXT_PUBLIC_BASE_URL }}
          NEXT_PUBLIC_API_URL: ${{ vars.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_APP_URL: ${{ vars.NEXT_PUBLIC_APP_URL }}
          CONTACT_EMAIL: ${{ vars.CONTACT_EMAIL }}
          AWS_REGION: ${{ env.AWS_REGION }}
        run: pnpm build

      - name: Install CDK Dependencies
        working-directory: infrastructure
        run: pnpm install --frozen-lockfile

      - name: Detect infrastructure changes
        id: changes
        shell: bash
        run: |
          set -euo pipefail

          before="${{ github.event.before }}"
          sha="${{ github.sha }}"

          # If this is the first commit on the branch history, assume infra may have changed.
          if [[ -z "${before}" || "${before}" == "0000000000000000000000000000000000000000" ]]; then
            echo "infra_changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if git diff --name-only "${before}" "${sha}" | grep -q '^infrastructure/'; then
            echo "infra_changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "infra_changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Preflight - verify CDK bootstrap access
        shell: bash
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
        run: |
          set -euo pipefail
          ACCOUNT_ID="$(aws sts get-caller-identity --query Account --output text)"
          BOOTSTRAP_PARAM="/cdk-bootstrap/hnb659fds/version"

          echo "AWS account: ${ACCOUNT_ID}"
          echo "Checking bootstrap SSM parameter: ${BOOTSTRAP_PARAM}"

          if ! BOOTSTRAP_VERSION="$(aws ssm get-parameter --name "${BOOTSTRAP_PARAM}" --region "${AWS_REGION}" --query 'Parameter.Value' --output text 2>&1)"; then
            echo "ERROR: Unable to read ${BOOTSTRAP_PARAM} (required by CDK modern bootstrap)." >&2
            echo "${BOOTSTRAP_VERSION}" >&2
            echo "" >&2
            echo "Fix (IAM): allow ssm:GetParameter on arn:aws:ssm:${AWS_REGION}:${ACCOUNT_ID}:parameter${BOOTSTRAP_PARAM}" >&2
            echo "Fix (Bootstrap): ensure environment is bootstrapped: cdk bootstrap aws://${ACCOUNT_ID}/${AWS_REGION}" >&2
            exit 1
          fi

          echo "Bootstrap template version: ${BOOTSTRAP_VERSION}"

      - name: Preflight - verify CloudFormation exports access
        shell: bash
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
        run: |
          set -euo pipefail

          if ! OUTPUT="$(aws cloudformation list-exports --max-items 1 --region "${AWS_REGION}" 2>&1)"; then
            echo "ERROR: Unable to call CloudFormation ListExports (required by deploy-static-site.mjs)." >&2
            echo "${OUTPUT}" >&2
            echo "" >&2
            echo "Fix (IAM): allow cloudformation:ListExports on Resource \"*\" for the deploy role." >&2
            exit 1
          fi

      - name: Deploy Storage Stack (CloudFront Functions + CSP KVS)
        if: ${{ github.event_name != 'workflow_dispatch' || inputs.dry_run != true }}
        working-directory: infrastructure
        env:
          DOCKER_DEFAULT_PLATFORM: linux/amd64
        run: pnpm cdk deploy prod-portfolio-storage --require-approval never

      - name: Deploy Email Stack (infra changes only)
        if: ${{ (github.event_name != 'workflow_dispatch' || inputs.dry_run != true) && steps.changes.outputs.infra_changed == 'true' }}
        working-directory: infrastructure
        env:
          DOCKER_DEFAULT_PLATFORM: linux/amd64
        run: pnpm cdk deploy prod-portfolio-email --require-approval never

      - name: Deploy Monitoring Stack (infra changes only)
        if: ${{ (github.event_name != 'workflow_dispatch' || inputs.dry_run != true) && steps.changes.outputs.infra_changed == 'true' }}
        working-directory: infrastructure
        env:
          DOCKER_DEFAULT_PLATFORM: linux/amd64
        run: pnpm cdk deploy prod-portfolio-monitoring --require-approval never

      - name: Preflight - verify static deploy permissions (S3 + CSP KVS)
        shell: bash
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
        run: |
          set -euo pipefail

          STACK_ENV="prod"
          bucket="$(aws cloudformation list-exports --region "${AWS_REGION}" --query "Exports[?Name=='${STACK_ENV}-website-bucket-name'].Value | [0]" --output text)"
          distribution_id="$(aws cloudformation list-exports --region "${AWS_REGION}" --query "Exports[?Name=='${STACK_ENV}-distribution-id'].Value | [0]" --output text)"
          kvs_arn="$(aws cloudformation list-exports --region "${AWS_REGION}" --query "Exports[?Name=='${STACK_ENV}-csp-hashes-kvs-arn'].Value | [0]" --output text)"

          if [[ -z "${bucket}" || "${bucket}" == "None" ]]; then
            echo "ERROR: Unable to resolve export: ${STACK_ENV}-website-bucket-name" >&2
            exit 1
          fi
          if [[ -z "${distribution_id}" || "${distribution_id}" == "None" ]]; then
            echo "ERROR: Unable to resolve export: ${STACK_ENV}-distribution-id" >&2
            exit 1
          fi
          if [[ -z "${kvs_arn}" || "${kvs_arn}" == "None" ]]; then
            echo "ERROR: Unable to resolve export: ${STACK_ENV}-csp-hashes-kvs-arn" >&2
            exit 1
          fi

          if ! aws s3 ls "s3://${bucket}" >/dev/null 2>&1; then
            echo "ERROR: Unable to list S3 bucket s3://${bucket} (required by deploy-static-site.mjs)." >&2
            echo "Fix (IAM): allow s3:ListBucket on arn:aws:s3:::${bucket} (and object write permissions)." >&2
            exit 1
          fi

          if ! aws cloudfront-keyvaluestore describe-key-value-store --kvs-arn "${kvs_arn}" >/dev/null 2>&1; then
            echo "ERROR: Unable to describe CloudFront KeyValueStore ${kvs_arn} (required by deploy-static-site.mjs)." >&2
            echo "Fix (IAM): allow cloudfront-keyvaluestore:DescribeKeyValueStore/ListKeys/UpdateKeys on ${kvs_arn}." >&2
            exit 1
          fi

          if ! aws cloudfront list-invalidations --distribution-id "${distribution_id}" --max-items 1 >/dev/null 2>&1; then
            echo "ERROR: Unable to list CloudFront invalidations for distribution ${distribution_id} (required by deploy-static-site.mjs)." >&2
            echo "Fix (IAM): allow cloudfront:ListInvalidations/GetInvalidation/CreateInvalidation on the distribution ARN." >&2
            exit 1
          fi

      - name: Deploy static export (S3 + KVS + invalidation)
        if: ${{ github.event_name != 'workflow_dispatch' || inputs.dry_run != true }}
        run: pnpm deploy:static:prod

      - name: Deploy static export (dry-run)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.dry_run == true }}
        run: node scripts/deploy-static-site.mjs --env prod --dry-run

  smoke-check:
    name: Post-Deploy Smoke Check
    runs-on: ubuntu-latest
    needs: deploy
    if: |
      needs.deploy.result == 'success' &&
      !(
        github.event_name == 'workflow_dispatch' &&
        (inputs.dry_run == true || inputs.skip_smoke_check == true)
      )

    steps:
      - name: Run smoke check
        id: smoke
        env:
          SMOKE_URL: ${{ vars.NEXT_PUBLIC_APP_URL }}
        run: |
          set +e
          url="${SMOKE_URL:-https://bjornmelin.io}"
          http_code=$(curl --retry 3 --retry-delay 5 --max-time 15 -s -o /tmp/response "$url" -w "%{http_code}")
          exit_code=$?

          echo "http_code=$http_code" >> "$GITHUB_OUTPUT"
          echo "exit_code=$exit_code" >> "$GITHUB_OUTPUT"

          if [ "$exit_code" -eq 0 ] && [ "$http_code" -ge 200 ] && [ "$http_code" -lt 400 ]; then
            echo "status=success" >> "$GITHUB_OUTPUT"
          else
            echo "status=failure" >> "$GITHUB_OUTPUT"
            echo "Smoke check failed for $url (exit: $exit_code, status: $http_code)."
            if [ "${SMOKE_DEBUG:-false}" = "true" ]; then
              echo "----- Response Body (truncated) -----"
              head -c 2048 /tmp/response || true
            fi
          fi

      - name: Deployment summary
        if: always()
        env:
          APP_URL: ${{ vars.NEXT_PUBLIC_APP_URL }}
          SMOKE_STATUS: ${{ steps.smoke.outputs.status }}
          SMOKE_HTTP_CODE: ${{ steps.smoke.outputs.http_code }}
        run: |
          status="${SMOKE_STATUS:-unknown}"
          http_code="${SMOKE_HTTP_CODE:-n/a}"
          app_url="${APP_URL:-https://bjornmelin.io}"
          {
            echo "## Deployment Summary"
            echo ""
            echo "- Commit: \`$GITHUB_SHA\`"
            echo "- Workflow Run: https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
            echo "- App URL: ${app_url}"
            echo "- Smoke Check Status: ${status:-unknown}"
            echo "- HTTP Status Code: ${http_code}"
            echo "- Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Fail when smoke check failed
        if: ${{ steps.smoke.outputs.status == 'failure' }}
        run: |
          echo "Smoke check did not succeed. Failing workflow."
          exit 1
