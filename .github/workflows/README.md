# GitHub Actions Workflows

This directory contains all the GitHub Actions workflows for the bjornmelin-platform-io project.

## Workflows Overview

### Core CI/CD

1. **_reusable-ci.yml** - Reusable CI workflow (internal)
   - Called by: ci.yml, deploy.yml
   - Jobs: Lint, type check, unit tests, E2E tests, build
   - Features: pnpm caching via composite action, parallel jobs, artifact uploads

2. **ci.yml** - Main continuous integration workflow
   - Runs on: Push to main/develop, PRs
   - Calls: _reusable-ci.yml
   - Jobs: CI pipeline, actionlint validation

3. **deploy.yml** - Production deployment workflow
   - Runs on: Push to main (excludes `**.md`)
   - Calls: _reusable-ci.yml for testing
   - Features: AWS OIDC authentication, preflight config validation, static build,
     **CDK Storage deploy (CloudFront Functions + CSP KVS)**, static deploy (`pnpm deploy:static:prod`),
     CloudFront invalidation, smoke check, job summary
   - workflow_dispatch inputs: `dry_run` (skip S3 upload / KVS sync / invalidation) and `skip_smoke_check`

4. **release-please.yml** - Automated semantic versioning and releases
   - Runs on: Push to main
   - Features: Opens/updates Release PR based on conventional commits; creates git tags and GitHub Releases on merge
   - Uses: [googleapis/release-please-action@v4](https://github.com/googleapis/release-please-action)

5. **manual-deploy.yml** - Manual deployment workflow
   - Runs on: Workflow dispatch
   - Features: Environment selection, test skipping option, stack-output-based S3/KVS/CloudFront deploy,
     deployment tracking, concurrency control

### Security & Quality

6. **codeql.yml** - GitHub CodeQL security analysis
   - Runs on: Push, PRs, monthly schedule (15th at 06:00 UTC)
   - Scans: JavaScript/TypeScript code for vulnerabilities

7. **security-audit.yml** - Dependency security audit
   - Runs on: Push, PRs, monthly schedule (22nd at 08:00 UTC)
   - Features: pnpm audit, dependency review

8. **dependency-update.yml** - Automated dependency updates
   - Runs on: Monthly schedule (1st at 09:00 UTC)
   - Features: Non-major updates, automated PR creation

### Maintenance

9. **branch-protection.yml** - PR validation and protection
   - Runs on: Pull requests to main
   - Features: Conventional commit check, merge conflict detection, auto-labeling

10. **pr-labeler.yml** - Automatic PR labeling
    - Runs on: PR opened/edited
    - Features: Path-based labels, conventional commit labels

11. **stale.yml** - Manage stale issues and PRs
    - Runs on: Monthly schedule (1st of each month at 00:00 UTC)
    - Features: Auto-close inactive items, configurable timelines

12. **link-check.yml** - Check for broken links
    - Runs on: Push, PRs, monthly schedule (8th at 04:00 UTC)
    - Features: Markdown link validation, issue creation on failure
    - Exclusions:
      - `https://bjornmelin.io` and `https://www.bjornmelin.io` are intentionally excluded because this
        workflow is for documentation/external link hygiene and should not fail PRs/scheduled runs when
        the production site returns transient 5xx (e.g., CloudFront edge/runtime errors during deploys).
      - Production availability is validated separately by `deploy.yml` via the post-deploy smoke check.
      - `https://github.com/BjornMelin/bjornmelin-platform-io/compare/*` URLs are excluded because they are
        auto-generated by release-please and reference tags under repository control. These URLs can return
        transient 404s due to GitHub API rate-limiting or eventual consistency during CI runs, but broken tags
        would be detected by git operations and PR checks.
      - Approved by: Bjorn Melin
      - Follow-up: keep excluded; if homepage availability should be continuously validated, add a
        dedicated uptime/smoke check (or a stable `/healthz` endpoint) rather than gating docs link
        checks on prod status.

### Performance

13. **performance-check.yml** - Performance monitoring
    - Runs on: Push to main, PRs
    - Features: Lighthouse CI, bundle size analysis
    - Metrics: Performance, accessibility, SEO, best practices

### Infrastructure

14. **infrastructure.yml** - AWS CDK infrastructure deployment
    - Runs on: Workflow dispatch
    - Features: CDK deploy for DNS, storage, email, monitoring stacks

## Reusable Workflow Architecture

```text
ci.yml ─────────────────┐
                        ├──► _reusable-ci.yml ──► lint, test, build
deploy.yml ─────────────┘
```

The `_reusable-ci.yml` workflow consolidates common CI logic:

- Lint and type checking
- Unit tests with coverage
- E2E tests with Playwright
- Production build verification

This eliminates duplicate test runs and ensures consistent CI behavior.

## Composite Actions

- **setup-node-pnpm** - Sets up Node.js (from .nvmrc) and pnpm via Corepack
  - Automatically caches pnpm store
  - Activates exact pnpm version from package.json
  - Optionally installs dependencies

## Configuration Files

- **dependabot.yml** - Dependabot configuration for automated dependency updates
- **auto-assign.yml** - Auto-assignment configuration for PRs
- **labeler.yml** - Path-based labeling configuration
- **lighthouse/lighthouserc.json** - Lighthouse CI configuration

## AWS OIDC Authentication

These workflows use GitHub OIDC for keyless AWS authentication, eliminating long-lived credentials.

### Setup Requirements

1. **Create OIDC Provider** (once per AWS account):

   ```bash
   aws iam create-open-id-connect-provider \
     --url https://token.actions.githubusercontent.com \
     --client-id-list sts.amazonaws.com \
     --thumbprint-list 6938fd4d98bab03faadb97b34396831e3780aea1
   ```

2. **Create IAM Role** with OIDC trust policy (see [infrastructure/README.md](../../infrastructure/README.md)).
   For CDK workflows, the role must be able to read the CDK bootstrap version SSM parameter
   (`/cdk-bootstrap/hnb659fds/version`) and (recommended) assume the CDK bootstrap roles.
   The deploy workflow also requires static deploy permissions (CloudFormation exports, S3 sync,
   CloudFront invalidation, and KVS sync) as documented in `infrastructure/README.md`.
   Helper scripts:
   - `bash scripts/ops/fix-gh-oidc-cdk-bootstrap-policy.sh --role-name prod-portfolio-deploy`
   - `bash scripts/ops/fix-gh-oidc-static-deploy-policy.sh --role-name prod-portfolio-deploy --env prod`

3. **Add Role ARN to GitHub Environment `production` secret** as `AWS_DEPLOY_ROLE_ARN`

### Workflow Credentials Reference

| Workflow | Secret Used | Purpose |
| :--- | :--- | :--- |
| `deploy.yml` | `secrets.AWS_DEPLOY_ROLE_ARN` | Production deployment |
| `infrastructure.yml` | `secrets.AWS_DEPLOY_ROLE_ARN` | CDK stack deployment |
| `manual-deploy.yml` | `secrets.AWS_DEPLOY_ROLE_ARN` | Manual deployment |

## Environment Variables & Secrets

Required secrets:

- `GITHUB_TOKEN` - Automatically provided by GitHub
- `CODECOV_TOKEN` - For code coverage reporting (optional)
- `AWS_DEPLOY_ROLE_ARN` - IAM role ARN for OIDC authentication (recommended as an **Environment secret** on `production`)

Required variables (set in GitHub Environment):

- `NEXT_PUBLIC_BASE_URL` - Base URL for the application
- `NEXT_PUBLIC_API_URL` - API endpoint URL
- `NEXT_PUBLIC_APP_URL` - Public app URL
- `CONTACT_EMAIL` - Contact form recipient email

## Branch Protection Settings

Recommended branch protection for `main`:

- Require PR reviews (1+)
- Dismiss stale PR approvals
- Require status checks:
  - CI / All CI Checks Passed
  - CodeQL / Analyze
  - Security Audit / Security Audit
  - Security Audit / Dependency Review
- Require branches to be up to date
- Include administrators
- Restrict who can push to matching branches

## Workflow Badges

Add these badges to your README:

```markdown
[![CI](https://github.com/bjornmelin/bjornmelin-platform-io/actions/workflows/ci.yml/badge.svg)](https://github.com/bjornmelin/bjornmelin-platform-io/actions/workflows/ci.yml)
[![CodeQL](https://github.com/bjornmelin/bjornmelin-platform-io/actions/workflows/codeql.yml/badge.svg)](https://github.com/bjornmelin/bjornmelin-platform-io/actions/workflows/codeql.yml)
[![Security Audit](https://github.com/bjornmelin/bjornmelin-platform-io/actions/workflows/security-audit.yml/badge.svg)](https://github.com/bjornmelin/bjornmelin-platform-io/actions/workflows/security-audit.yml)
```

## Best Practices

1. **Reusable Workflows**: Common CI logic consolidated in `_reusable-ci.yml`
2. **Composite Actions**: Node.js/pnpm setup via `.github/actions/setup-node-pnpm`
3. **Caching**: pnpm store cached automatically by composite action
4. **Concurrency**: Workflows use concurrency groups to cancel redundant runs
5. **Artifacts**: Test results and build artifacts uploaded for debugging
6. **Workflow Linting**: CI runs actionlint to validate workflow expressions
7. **Security**: CodeQL, dependency audits, OIDC-based AWS access
8. **Job Summaries**: Use `GITHUB_STEP_SUMMARY` for routine reporting instead of PR comments
9. **Schedule Spreading**: Monthly workflows spread across the month to avoid bottlenecks

## PR Comment Policy

- **Primary source of truth**: job summaries on the workflow run page (`GITHUB_STEP_SUMMARY`).
- **Performance (Lighthouse)**: sticky PR comment only on failure or meaningful score deltas; summary is always written.
- **Dependency Review**: PR comments only on failure; ensure the check is required in branch protection.
- **Stale PRs**: one minimal warning comment; no close comment.
- **Deployments**: no commit comments; deployment details live in the run summary and deployment status.

## Scheduled Workflow Calendar

| Day | Workflow | Time (UTC) |
| --- | -------- | ---------- |
| 1st | stale.yml | 00:00 |
| 1st | dependency-update.yml | 09:00 |
| 8th | link-check.yml | 04:00 |
| 15th | codeql.yml | 06:00 |
| 22nd | security-audit.yml | 08:00 |

## Troubleshooting

If workflows fail:

1. Check the workflow logs in the Actions tab
2. Verify all required secrets and variables are set
3. Ensure branch protection rules aren't blocking required checks
4. Check for pnpm lockfile issues with `pnpm install --frozen-lockfile`
5. Verify Node.js version compatibility (requires 24.x LTS)

## Local Testing

Test workflows locally using [act](https://github.com/nektos/act):

```bash
# Install act
brew install act  # macOS
# or download from releases

# Test CI workflow
act -j lint-and-type-check

# Test with specific event
act pull_request

# List all workflows
act -l
```
