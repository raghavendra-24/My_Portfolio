name: Performance Check

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

env:
  SKIP_ENV_VALIDATION: 'true'

concurrency:
  group: performance-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  lighthouse:
    name: Lighthouse CI
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          install: "true"

      - name: Build application
        run: pnpm build
        env:
          NEXT_PUBLIC_BASE_URL: https://bjornmelin.io
          NEXT_PUBLIC_APP_URL: https://bjornmelin.io
          AWS_REGION: us-east-1
          CONTACT_EMAIL: test@example.com
          NODE_ENV: production

      - name: Run Lighthouse CI
        id: lighthouse
        uses: treosh/lighthouse-ci-action@v12
        with:
          uploadArtifacts: true
          temporaryPublicStorage: true
          configPath: ./.github/lighthouse/lighthouserc.json

      - name: Write Lighthouse summary
        if: always()
        run: |
          node <<'NODE'
          const fs = require('fs');
          const summary = process.env.GITHUB_STEP_SUMMARY;
          const resultPath = './lighthouse-results.json';
          const lines = [];
          lines.push('## Lighthouse Performance Report');
          lines.push('');
          if (fs.existsSync(resultPath)) {
            try {
              const results = JSON.parse(fs.readFileSync(resultPath, 'utf8'));
              lines.push('| Metric | Score |');
              lines.push('|--------|-------|');
              lines.push(`| Performance | ${results.performance}% |`);
              lines.push(`| Accessibility | ${results.accessibility}% |`);
              lines.push(`| Best Practices | ${results.bestPractices}% |`);
              lines.push(`| SEO | ${results.seo}% |`);
            } catch (err) {
              lines.push(`‚ö†Ô∏è Error parsing Lighthouse results: ${err.message}`);
            }
          } else {
            lines.push('‚ö†Ô∏è Lighthouse results not found. The performance check may have failed.');
          }
          lines.push('');
          fs.appendFileSync(summary, lines.join('\n'));
          NODE

      - name: Evaluate Lighthouse comment criteria
        id: lighthouse-comment
        if: always()
        uses: actions/github-script@v8
        env:
          LIGHTHOUSE_OUTCOME: ${{ steps.lighthouse.outcome }}
          LH_DELTA_THRESHOLD: '5'
        with:
          script: |
            const fs = require('fs');
            const isPullRequest = context.eventName === 'pull_request';
            const isFork = context.payload.pull_request?.head?.repo?.fork === true;
            if (!isPullRequest || isFork) {
              core.setOutput('should_comment', 'false');
              return;
            }

            const resultPath = './lighthouse-results.json';
            let metrics = null;
            let errorMessage = null;
            if (fs.existsSync(resultPath)) {
              try {
                const results = JSON.parse(fs.readFileSync(resultPath, 'utf8'));
                metrics = {
                  performance: results.performance,
                  accessibility: results.accessibility,
                  bestPractices: results.bestPractices,
                  seo: results.seo,
                };
              } catch (error) {
                errorMessage = `Error parsing Lighthouse results: ${error.message}`;
              }
            } else {
              errorMessage = 'Lighthouse results not found. The performance check may have failed.';
            }

            const failed = process.env.LIGHTHOUSE_OUTCOME !== 'success';
            const threshold = Number(process.env.LH_DELTA_THRESHOLD || '5');
            let previous = null;

            const comments = await github.paginate(github.rest.issues.listComments, {
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100,
            });

            let previousComment = null;
            for (let i = comments.length - 1; i >= 0; i -= 1) {
              const comment = comments[i];
              if (comment.body && comment.body.includes('<!-- lighthouse-report-json:')) {
                previousComment = comment;
                break;
              }
            }

            if (previousComment) {
              const match = previousComment.body.match(
                /<!-- lighthouse-report-json:\s*(\{[\s\S]*?\})\s*-->/
              );
              if (match) {
                try {
                  previous = JSON.parse(match[1]);
                } catch (e) {
                  core.debug(
                    `Failed to parse previous Lighthouse metrics: ${e?.message ?? e}`
                  );
                  previous = null;
                }
              }
            }

            let delta = null;
            if (metrics && previous) {
              const diffs = ['performance', 'accessibility', 'bestPractices', 'seo'].map((key) =>
                Math.abs((metrics[key] ?? 0) - (previous[key] ?? 0))
              );
              delta = Math.max(...diffs);
            }

            const shouldComment =
              failed || !previous || Boolean(errorMessage) || (delta !== null && delta >= threshold);

            const title = '## üö¶ Lighthouse Performance Report';
            let body = `${title}\n\n`;
            if (metrics) {
              body += `| Metric | Score |\n|--------|-------|\n`;
              body += `| Performance | ${metrics.performance}% |\n`;
              body += `| Accessibility | ${metrics.accessibility}% |\n`;
              body += `| Best Practices | ${metrics.bestPractices}% |\n`;
              body += `| SEO | ${metrics.seo}% |\n`;
            } else {
              body += `‚ö†Ô∏è ${errorMessage}\n`;
            }
            const json = metrics ?? previous ?? {};
            body += `\n<!-- lighthouse-report-json: ${JSON.stringify(json)} -->\n`;

            core.setOutput('should_comment', shouldComment ? 'true' : 'false');
            core.setOutput('comment_body', body);

      - name: Post Lighthouse sticky comment
        if: steps.lighthouse-comment.outputs.should_comment == 'true'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: lighthouse-report
          message: ${{ steps.lighthouse-comment.outputs.comment_body }}

  bundle-size:
    name: Bundle Size Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          install: "true"

      - name: Build and analyze bundle
        env:
          NEXT_PUBLIC_BASE_URL: https://bjornmelin.io
          NEXT_PUBLIC_APP_URL: https://bjornmelin.io
          AWS_REGION: us-east-1
          CONTACT_EMAIL: test@example.com
        run: |
          pnpm build

          # Generate bundle report
          {
            echo "## Bundle Size Report"
            echo ""
            echo "### Static Output"
            echo "\`\`\`"
            du -sh out/
            echo "\`\`\`"
            echo ""
            echo "### JavaScript Bundles (Top 20 by size)"
            echo "| File | Size | Gzipped |"
            echo "|------|------|---------|"
          } > bundle-report.md

          # Find and measure JS bundles (sorted by size, top 20)
          find out/_next/static -name "*.js" -type f -exec du -b {} \; 2>/dev/null | \
            sort -rn | head -20 | while read -r bytes file; do
              size=$(numfmt --to=iec "$bytes")
              gzipped=$(gzip -c "$file" | wc -c | numfmt --to=iec)
              filename=$(basename "$file")
              echo "| \`$filename\` | $size | $gzipped |" >> bundle-report.md
            done

      - name: Upload bundle analysis
        uses: actions/upload-artifact@v6
        with:
          name: bundle-analysis
          path: bundle-report.md
          retention-days: 7
